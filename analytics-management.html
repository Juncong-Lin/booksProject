<!DOCTYPE html>
<html>
  <head>
    <title>Analytics Data Management - Juncongmall.com</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no"
    />

    <!-- Load fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />

    <!-- CSS files -->
    <link rel="stylesheet" href="styles/shared/general.css" />
    <link rel="stylesheet" href="styles/shared/qili-header.css" />
    <link rel="stylesheet" href="styles/shared/sub-header.css" />
    <link rel="stylesheet" href="styles/pages/dashboard.css" />
    <link rel="stylesheet" href="styles/pages/analytics-management.css" />
    <link rel="stylesheet" href="styles/shared/footer.css" />

    <!-- Additional libraries for enhanced UI -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  </head>

  <body class="no-sidebar dashboard-theme">
    <!-- Header -->
    <div id="shared-header-placeholder"></div>
    <div id="shared-subheader-placeholder"></div>

    <!-- Gradient Background -->
    <div class="dashboard-background">
      <div class="gradient-orb orb-1"></div>
      <div class="gradient-orb orb-2"></div>
      <div class="gradient-orb orb-3"></div>
    </div>

    <div class="main">
      <div class="management-container animate__animated animate__fadeIn">
        <!-- Dashboard Header -->
        <div class="management-header">
          <div class="header-content">
            <div class="title-section">
              <div class="breadcrumb">
                <span class="breadcrumb-item">Analytics</span>
                <i
                  data-feather="chevron-right"
                  class="breadcrumb-separator"
                ></i>
                <span class="breadcrumb-item active">Data Management</span>
              </div>
              <h1 class="management-title">
                <i data-feather="database" class="title-icon"></i>
                Analytics Data Management
              </h1>
              <p class="management-subtitle">
                Manage and monitor your website analytics data with advanced
                controls
              </p>
            </div>
            <div class="header-actions">
              <button class="action-btn refresh-btn" id="refresh-system">
                <i data-feather="refresh-cw"></i>
                <span>Refresh</span>
              </button>
              <a href="dashboard.html" class="action-btn primary">
                <i data-feather="bar-chart-2"></i>
                <span>View Dashboard</span>
              </a>
            </div>
          </div>

          <!-- Live Status Indicator -->
          <div class="live-status">
            <div class="status-indicator">
              <div class="status-dot"></div>
              <span>System Online</span>
            </div>
            <div class="last-updated">
              Last action: <span id="last-action-time">System initialized</span>
            </div>
          </div>
        </div>

        <!-- Data Statistics Cards -->
        <div
          class="data-stats animate__animated animate__slideInUp"
          style="animation-delay: 0.1s"
        >
          <div class="stat-card">
            <div class="stat-value" id="total-events">0</div>
            <div class="stat-label">Total Events</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="unique-sessions-stat">0</div>
            <div class="stat-label">Unique Sessions</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="storage-size">0 KB</div>
            <div class="stat-label">Storage Used</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="last-event">Never</div>
            <div class="stat-label">Last Event</div>
          </div>
        </div>

        <div class="action-cards">
          <div
            class="action-card animate__animated animate__slideInUp"
            style="animation-delay: 0.2s"
          >
            <div class="card-header">
              <div class="card-icon clear-data">
                <i data-feather="trash-2"></i>
              </div>
            </div>
            <h3>Clear Analytics Data</h3>
            <p>
              Remove all stored analytics data from local storage. This action
              will reset all metrics and cannot be undone.
            </p>
            <button class="action-btn danger" onclick="clearData()">
              <i data-feather="trash-2"></i>
              Clear All Data
            </button>
          </div>

          <div
            class="action-card animate__animated animate__slideInUp"
            style="animation-delay: 0.3s"
          >
            <div class="card-header">
              <div class="card-icon generate-data">
                <i data-feather="shuffle"></i>
              </div>
            </div>
            <h3>Generate Sample Data</h3>
            <p>
              Create realistic sample analytics data for testing and
              demonstration purposes. Includes user journeys and conversion
              events.
            </p>
            <button class="action-btn success" onclick="generateSampleData()">
              <i data-feather="shuffle"></i>
              Generate Sample Data
            </button>
          </div>

          <div
            class="action-card animate__animated animate__slideInUp"
            style="animation-delay: 0.4s"
          >
            <div class="card-header">
              <div class="card-icon view-data">
                <i data-feather="eye"></i>
              </div>
            </div>
            <h3>View Current Data</h3>
            <p>
              Display a summary of current analytics data including page views,
              sessions, and conversion metrics.
            </p>
            <button class="action-btn" onclick="showCurrentData()">
              <i data-feather="eye"></i>
              Show Data Summary
            </button>
          </div>

          <div
            class="action-card animate__animated animate__slideInUp"
            style="animation-delay: 0.5s"
          >
            <div class="card-header">
              <div class="card-icon export-data">
                <i data-feather="download"></i>
              </div>
            </div>
            <h3>Export Analytics Data</h3>
            <p>
              Download all analytics data as a JSON file for backup or external
              analysis. Includes complete event history and metadata.
            </p>
            <button class="action-btn warning" onclick="exportData()">
              <i data-feather="download"></i>
              Export Data
            </button>
          </div>
        </div>

        <div
          class="quick-actions animate__animated animate__slideInUp"
          style="animation-delay: 0.6s"
        >
          <a href="dashboard.html" class="quick-btn">
            <i data-feather="bar-chart-2"></i>
            View Dashboard
          </a>
          <button class="quick-btn" onclick="refreshAnalytics()">
            <i data-feather="refresh-cw"></i>
            Refresh Analytics
          </button>
          <button class="quick-btn" onclick="simulateActivity()">
            <i data-feather="activity"></i>
            Simulate Activity
          </button>
          <button class="quick-btn" onclick="validateData()">
            <i data-feather="check-circle"></i>
            Validate Data
          </button>
        </div>

        <div
          class="output-section animate__animated animate__slideInUp"
          style="animation-delay: 0.7s"
        >
          <div class="output-header">
            <h3>
              <i data-feather="terminal"></i>
              System Output
            </h3>
            <button class="clear-output-btn" onclick="clearOutput()">
              <i data-feather="x"></i>
              Clear Output
            </button>
          </div>
          <div id="output" class="output-content"></div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div id="shared-footer-placeholder"></div>

    <!-- Scripts -->
    <script type="module">
      import { SimpleAnalytics } from "./scripts/shared/analytics.js";

      // Helper function to show loading state
      function showLoading(button) {
        button.classList.add("loading");
        button.disabled = true;
      }

      function hideLoading(button) {
        button.classList.remove("loading");
        button.disabled = false;
      }

      // Helper function to update last action time
      function updateLastActionTime(action) {
        const timestamp = new Date().toLocaleTimeString();
        const lastActionElement = document.getElementById("last-action-time");
        if (lastActionElement) {
          lastActionElement.textContent = `${action} at ${timestamp}`;
        }
      }

      // Helper function to update statistics
      function updateStats() {
        try {
          const data = SimpleAnalytics.getAnalyticsData();

          document.getElementById("total-events").textContent =
            data.historical.length;
          document.getElementById("unique-sessions-stat").textContent =
            data.summary.uniqueSessions;

          // Calculate storage size
          const storageSize = JSON.stringify(data).length;
          const sizeInKB = (storageSize / 1024).toFixed(1);
          document.getElementById(
            "storage-size"
          ).textContent = `${sizeInKB} KB`;

          // Last event time
          if (data.historical.length > 0) {
            const lastEvent = data.historical[data.historical.length - 1];
            const lastEventTime = new Date(
              lastEvent.timestamp
            ).toLocaleTimeString();
            document.getElementById("last-event").textContent = lastEventTime;
          } else {
            document.getElementById("last-event").textContent = "Never";
          }
        } catch (error) {
          console.error("Error updating stats:", error);
        }
      }

      // Helper function to add output with timestamp and animation
      function addOutput(message, type = "info") {
        const output = document.getElementById("output");
        const timestamp = new Date().toLocaleTimeString();
        const typeIcon =
          {
            info: "ℹ️",
            success: "✅",
            warning: "⚠️",
            error: "❌",
            system: "⚙️",
          }[type] || "ℹ️";

        const newContent = `[${timestamp}] ${typeIcon} ${message}\n`;
        output.textContent = newContent + output.textContent;

        // Auto-scroll to top for new content
        output.scrollTop = 0;

        // Update stats after any data operation
        updateStats();
      }

      // Enhanced functions with better interactivity
      window.clearData = function () {
        const button = event.target.closest(".action-btn");
        const card = button.closest(".action-card");

        // Show confirmation dialog
        if (
          !confirm(
            "Are you sure you want to clear all analytics data? This action cannot be undone."
          )
        ) {
          return;
        }

        showLoading(button);
        showProgressIndicator();

        setTimeout(() => {
          localStorage.removeItem("analytics_data");
          localStorage.removeItem("analytics_history");
          addOutput("Analytics data cleared successfully!", "success");
          addOutput(
            "All historical events have been removed from local storage.",
            "info"
          );
          addOutput("System ready for new data collection.", "system");
          updateLastActionTime("Data cleared");
          hideLoading(button);
          hideProgressIndicator();
          addFeedbackToCard(card, "success");
          showNotification(
            "All analytics data cleared successfully!",
            "success"
          );
        }, 1000);
      };

      window.generateSampleData = function () {
        const button = event.target.closest(".action-btn");
        const card = button.closest(".action-card");
        showLoading(button);
        showProgressIndicator();

        setTimeout(() => {
          SimpleAnalytics.generateSampleData();
          const data = SimpleAnalytics.getAnalyticsData();
          addOutput("Sample data generated successfully!", "success");
          addOutput(
            `Generated ${data.historical.length} events across ${data.summary.uniqueSessions} sessions.`,
            "info"
          );
          addOutput(
            `Page views: ${data.summary.pageViews}, Clicks: ${data.summary.totalClicks}`,
            "info"
          );
          addOutput(
            "Sample data includes realistic user journeys and conversion events.",
            "system"
          );
          updateLastActionTime("Sample data generated");
          hideLoading(button);
          hideProgressIndicator();
          addFeedbackToCard(card, "success");
          showNotification(
            `Generated ${data.historical.length} sample events!`,
            "success"
          );
        }, 1500);
      };

      window.showCurrentData = function () {
        const button = event.target.closest(".action-btn");
        const card = button.closest(".action-card");
        showLoading(button);
        showProgressIndicator();

        setTimeout(() => {
          const data = SimpleAnalytics.getAnalyticsData();
          addOutput("Current analytics data summary:", "info");
          addOutput(JSON.stringify(data.summary, null, 2), "system");
          addOutput(
            `Total events in history: ${data.historical.length}`,
            "info"
          );

          if (data.historical.length > 0) {
            const recentEvents = data.historical.slice(-5);
            addOutput("Recent events:", "info");
            recentEvents.forEach((event) => {
              addOutput(
                `${event.type}: ${event.element || event.page} at ${new Date(
                  event.timestamp
                ).toLocaleTimeString()}`,
                "system"
              );
            });
          }

          updateLastActionTime("Data viewed");
          hideLoading(button);
          hideProgressIndicator();
          addFeedbackToCard(card, "success");
          showNotification("Data summary displayed in output", "info");
        }, 800);
      };

      window.exportData = function () {
        const button = event.target.closest(".action-btn");
        const card = button.closest(".action-card");
        showLoading(button);
        showProgressIndicator();

        setTimeout(() => {
          const data = SimpleAnalytics.getAnalyticsData();
          const dataStr = JSON.stringify(data, null, 2);
          const dataBlob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement("a");
          link.href = url;
          const filename = `analytics-data-${
            new Date().toISOString().split("T")[0]
          }.json`;
          link.download = filename;
          link.click();
          URL.revokeObjectURL(url);

          addOutput("Analytics data exported successfully!", "success");
          addOutput(`File: ${filename}`, "info");
          addOutput(
            `Exported ${data.historical.length} events and summary data.`,
            "system"
          );
          updateLastActionTime("Data exported");
          hideLoading(button);
          hideProgressIndicator();
          addFeedbackToCard(card, "success");
          showNotification(`Data exported as ${filename}`, "success");
        }, 1000);
      };

      window.refreshAnalytics = function () {
        const button = event.target.closest(".quick-btn");
        showLoading(button);
        showProgressIndicator();

        setTimeout(() => {
          // Force refresh analytics by creating a new instance
          window.analytics = new SimpleAnalytics();
          addOutput("Analytics system refreshed!", "success");
          addOutput("New session started and tracking initialized.", "info");
          addOutput("All event listeners re-attached.", "system");
          updateLastActionTime("System refreshed");
          hideLoading(button);
          hideProgressIndicator();
          showNotification("Analytics system refreshed!", "success");
        }, 1200);
      };

      // New interactive functions
      window.simulateActivity = function () {
        const button = event.target.closest(".quick-btn");
        showLoading(button);
        showProgressIndicator();

        setTimeout(() => {
          // Simulate some user activity
          const activities = [
            {
              type: "pageview",
              page: "/products/books",
              element: "navigation",
            },
            { type: "click", page: "/products/books", element: "book-card-1" },
            {
              type: "scroll",
              page: "/products/books",
              element: "content-area",
            },
            {
              type: "click",
              page: "/products/books",
              element: "add-to-cart-btn",
            },
          ];

          activities.forEach((activity, index) => {
            setTimeout(() => {
              SimpleAnalytics.trackEvent(
                activity.type,
                activity.page,
                activity.element
              );
              addOutput(
                `Simulated ${activity.type} event on ${activity.page}`,
                "system"
              );
            }, index * 300);
          });

          setTimeout(() => {
            addOutput("Activity simulation completed!", "success");
            addOutput("4 synthetic events added to analytics data.", "info");
            updateLastActionTime("Activity simulated");
            hideLoading(button);
            hideProgressIndicator();
            showNotification(
              "Successfully simulated 4 user activities!",
              "success"
            );
          }, 1500);
        }, 500);
      };

      window.validateData = function () {
        const button = event.target.closest(".quick-btn");
        showLoading(button);
        showProgressIndicator();

        setTimeout(() => {
          const data = SimpleAnalytics.getAnalyticsData();
          let issues = 0;

          addOutput("Starting data validation...", "info");

          // Check for data integrity
          if (!data.summary) {
            addOutput("⚠️ Missing summary data", "warning");
            issues++;
          }

          if (!Array.isArray(data.historical)) {
            addOutput("⚠️ Historical data is not an array", "warning");
            issues++;
          }

          // Check for duplicate events
          const eventIds = new Set();
          data.historical.forEach((event) => {
            if (eventIds.has(event.id)) {
              addOutput(`⚠️ Duplicate event ID found: ${event.id}`, "warning");
              issues++;
            }
            eventIds.add(event.id);
          });

          // Check data consistency
          const summaryEvents =
            data.summary.pageViews + data.summary.totalClicks;
          if (summaryEvents !== data.historical.length) {
            addOutput(
              "⚠️ Summary totals don't match historical event count",
              "warning"
            );
            issues++;
          }

          if (issues === 0) {
            addOutput("✅ Data validation completed successfully!", "success");
            addOutput("No issues found in analytics data.", "info");
            showNotification(
              "Data validation passed! No issues found.",
              "success"
            );
          } else {
            addOutput(
              `Data validation completed with ${issues} issues found.`,
              "warning"
            );
            showNotification(
              `Data validation found ${issues} issues.`,
              "warning"
            );
          }

          updateLastActionTime("Data validated");
          hideLoading(button);
          hideProgressIndicator();
        }, 1500);
      };

      window.clearOutput = function () {
        document.getElementById("output").textContent = "";
        updateLastActionTime("Output cleared");
      };

      // Initialize page
      document.addEventListener("DOMContentLoaded", () => {
        // Initialize Feather icons
        feather.replace();

        // Update initial stats
        updateStats();

        addOutput("Analytics Data Management system initialized.", "success");
        addOutput("Ready to manage your analytics data.", "info");
        addOutput("All systems operational.", "system");

        // Add refresh button functionality
        const refreshBtn = document.getElementById("refresh-system");
        if (refreshBtn) {
          refreshBtn.addEventListener("click", function () {
            showProgressIndicator();
            setTimeout(() => {
              hideProgressIndicator();
              updateStats();
              addOutput("System status refreshed.", "info");
              updateLastActionTime("System refreshed");
              showNotification("System refreshed successfully!", "success");
            }, 1000);
          });
        }

        // Auto-update stats every 30 seconds
        setInterval(() => {
          updateStats();
        }, 30000);

        // Add keyboard shortcuts
        document.addEventListener("keydown", (e) => {
          if (e.ctrlKey || e.metaKey) {
            switch (e.key) {
              case "r":
                e.preventDefault();
                refreshAnalytics();
                break;
              case "e":
                e.preventDefault();
                exportData();
                break;
              case "s":
                e.preventDefault();
                simulateActivity();
                break;
              case "v":
                e.preventDefault();
                validateData();
                break;
            }
          }
        });

        // Add visual feedback to action cards
        const actionCards = document.querySelectorAll(".action-card");
        actionCards.forEach((card) => {
          card.addEventListener("mouseenter", () => {
            card.style.transform = "translateY(-8px) scale(1.02)";
          });

          card.addEventListener("mouseleave", () => {
            card.style.transform = "translateY(0) scale(1)";
          });
        });

        // Initialize tooltips for keyboard shortcuts
        addKeyboardShortcutTooltips();
      });

      // Enhanced utility functions
      function showProgressIndicator() {
        let indicator = document.querySelector(".progress-indicator");
        if (!indicator) {
          indicator = document.createElement("div");
          indicator.className = "progress-indicator";
          document.body.appendChild(indicator);
        }
        indicator.classList.add("active");
      }

      function hideProgressIndicator() {
        const indicator = document.querySelector(".progress-indicator");
        if (indicator) {
          indicator.classList.remove("active");
        }
      }

      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.textContent = message;

        document.body.appendChild(notification);

        // Trigger animation
        setTimeout(() => {
          notification.classList.add("show");
        }, 100);

        // Auto-remove after 3 seconds
        setTimeout(() => {
          notification.classList.remove("show");
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }, 3000);
      }

      function addKeyboardShortcutTooltips() {
        const shortcuts = [
          { selector: '[onclick="refreshAnalytics()"]', shortcut: "Ctrl+R" },
          { selector: '[onclick="exportData()"]', shortcut: "Ctrl+E" },
          { selector: '[onclick="simulateActivity()"]', shortcut: "Ctrl+S" },
          { selector: '[onclick="validateData()"]', shortcut: "Ctrl+V" },
        ];

        shortcuts.forEach(({ selector, shortcut }) => {
          const element = document.querySelector(selector);
          if (element) {
            element.title = `${element.textContent.trim()} (${shortcut})`;
          }
        });
      }

      function addFeedbackToCard(card, type) {
        card.classList.remove("feedback-success", "feedback-error");
        card.classList.add(`feedback-${type}`);

        setTimeout(() => {
          card.classList.remove(`feedback-${type}`);
        }, 2000);
      }
    </script>

    <!-- Shared component loaders -->
    <script src="scripts/shared/url-utils.js"></script>
    <script src="scripts/shared/shared-header-loader.js"></script>
    <script src="scripts/shared/shared-subheader-loader.js"></script>
    <script src="scripts/shared/shared-footer-loader.js"></script>
    <script src="scripts/shared/sub-header-nav.js"></script>

    <!-- Initialize additional features -->
    <script>
      // Add CSS for button spinning animation
      const style = document.createElement("style");
      style.textContent = `
        .spinning {
          animation: spin 1s linear infinite;
        }
        
        .action-btn:active {
          transform: translateY(0px);
        }
        
        .quick-btn:active {
          transform: translateY(0px);
        }
        
        /* Hover effects for icons */
        .card-icon {
          transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .action-card:hover .card-icon {
          transform: scale(1.1) rotate(5deg);
        }
        
        /* Interactive button states */
        .action-btn:hover:not(.loading) {
          transform: translateY(-2px) scale(1.02);
        }
        
        .quick-btn:hover:not(.loading) {
          transform: translateY(-2px) scale(1.02);
        }
        
        /* Success/Error feedback */
        .feedback-success {
          border-color: #10b981 !important;
          background: rgba(16, 185, 129, 0.1) !important;
        }
        
        .feedback-error {
          border-color: #ef4444 !important;
          background: rgba(239, 68, 68, 0.1) !important;
        }
      `;
      document.head.appendChild(style);
    </script>
  </body>
</html>
